name: Build and Release Magisk Module

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.36.1)'
        required: true
        default: '1.36.1'

env:
  NDK_VERSION: r25c
  BUSYBOX_VERSION: ${{ github.event.inputs.version || '1.36.1' }}

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      packages: read

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm
            triple: armv7a-linux-androideabi21-
            artifact: busybox-arm
          - arch: arm64
            triple: aarch64-linux-android21-
            artifact: busybox-arm64
          - arch: x86
            triple: i686-linux-android21-
            artifact: busybox-x86
          - arch: x86_64
            triple: x86_64-linux-android21-
            artifact: busybox-x86_64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git wget zip

      - name: Cache Android NDK
        id: cache-ndk
        uses: actions/cache@v4
        with:
          path: android-ndk-${{ env.NDK_VERSION }}-linux.zip
          key: ndk-${{ env.NDK_VERSION }}-${{ runner.os }}

      - name: Download Android NDK
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-${{ env.NDK_VERSION }}-linux.zip

      - name: Extract Android NDK
        run: |
          unzip -q android-ndk-${{ env.NDK_VERSION }}-linux.zip
          echo "NDK_ROOT=${{ github.workspace }}/android-ndk-${{ env.NDK_VERSION }}" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=${{ github.workspace }}/android-ndk-${{ env.NDK_VERSION }}" >> $GITHUB_ENV

      - name: Create NDK gcc symlinks
        run: |
          NDK_BIN="${{ env.NDK_ROOT }}/toolchains/llvm/prebuilt/linux-x86_64/bin"
          cd "$NDK_BIN"
          for target in aarch64-linux-android21 armv7a-linux-androideabi21 i686-linux-android21 x86_64-linux-android21; do
            # GCC/G++ -> Clang
            ln -sf "${target}-clang" "${target}-gcc"
            ln -sf "${target}-clang++" "${target}-g++"
            # AS -> Clang
            ln -sf "${target}-clang" "${target}-as"
            # Binutils -> LLVM tools
            ln -sf llvm-ar "${target}-ar"
            ln -sf llvm-nm "${target}-nm"
            ln -sf llvm-objcopy "${target}-objcopy"
            ln -sf llvm-objdump "${target}-objdump"
            ln -sf llvm-ranlib "${target}-ranlib"
            ln -sf llvm-strip "${target}-strip"
          done

      - name: Build BusyBox for ${{ matrix.arch }}
        run: |
          export NDK_ROOT="${{ env.NDK_ROOT }}"
          export PATH="$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
          export ARCH="${{ matrix.arch }}"
          export SYSROOT="$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          export CROSS_COMPILE="${{ matrix.triple }}"
          export HOSTCC="gcc"

          WORKSPACE="${{ github.workspace }}"
          cd "$WORKSPACE"
          wget -q https://busybox.net/downloads/busybox-${{ env.BUSYBOX_VERSION }}.tar.bz2
          tar -xjf busybox-${{ env.BUSYBOX_VERSION }}.tar.bz2
          mv busybox-${{ env.BUSYBOX_VERSION }} busybox-build
          cd busybox-build

          cp "$WORKSPACE"/osm0sis-basic-unified.config .config
          sed -i "s|CONFIG_CROSS_COMPILER_PREFIX=\"\"|CONFIG_CROSS_COMPILER_PREFIX=\"${NDK_ROOT}/toolchains/llvm/prebuilt/linux-x86_64/bin/${CROSS_COMPILE}\"|g" .config
          sed -i "s|CONFIG_SYSROOT=\"\"|CONFIG_SYSROOT=\"${SYSROOT}\"|g" .config
          sed -i 's|CONFIG_EXTRA_CFLAGS=.*|CONFIG_EXTRA_CFLAGS="-DANDROID -D__ANDROID__ -D__ANDROID_API__=21 -Os"|g' .config
          sed -i 's|CONFIG_EXTRA_LDFLAGS=.*|CONFIG_EXTRA_LDFLAGS="-Wl,-z,max-page-size=16384"|g' .config
          sed -i 's|CONFIG_STATIC=y|# CONFIG_STATIC is not set|g' .config
          sed -i 's|CONFIG_STATIC_LIBGCC=y|# CONFIG_STATIC_LIBGCC is not set|g' .config

          make -j$(nproc)
          make install

          mkdir -p "$WORKSPACE"/${{ matrix.artifact }}
          cp -r _install/* "$WORKSPACE"/${{ matrix.artifact }}/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ github.workspace }}/${{ matrix.artifact }}

  package:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Set up module structure
        run: |
          mkdir -p module/META-INF/com/google/android
          mkdir -p module/custom
          for dir in artifacts/*; do
            if [ -d "$dir" ]; then
              arch_name=$(basename "$dir" | sed 's/busybox-//')
              mkdir -p "module/custom/$arch_name"
              cp -r "$dir"/* "module/custom/$arch_name/"
            fi
          done

      - name: Create module.prop
        run: |
          echo "id=android-busybox-ndk" > module/module.prop
          echo "name=Android BusyBox NDK" >> module/module.prop
          echo "version=${{ env.BUSYBOX_VERSION }}" >> module/module.prop
          echo "versionCode=1" >> module/module.prop
          echo "author=GitHub Actions" >> module/module.prop
          echo "description=BusyBox ${{ env.BUSYBOX_VERSION }} compiled with Android NDK for Magisk" >> module/module.prop

      - name: Create update-binary
        run: |
          echo '#!/system/bin/sh' > module/META-INF/com/google/android/update-binary
          echo 'exit 0' >> module/META-INF/com/google/android/update-binary
          chmod 755 module/META-INF/com/google/android/update-binary

      - name: Create updater-script
        run: |
          echo 'ui_print(" BusyBox NDK Module");' > module/META-INF/com/google/android/updater-script

      - name: Create post-fs-data.sh
        run: |
          echo '#!/system/bin/sh' > module/post-fs-data.sh
          chmod 755 module/post-fs-data.sh

      - name: Create service.sh
        run: |
          echo '#!/system/bin/sh' > module/service.sh
          chmod 755 module/service.sh

      - name: Create customize.sh
        run: |
          echo '#!/system/bin/sh' > module/customize.sh
          echo '# Custom installation script for Magisk' >> module/customize.sh
          echo '' >> module/customize.sh
          echo '# Detect architecture' >> module/customize.sh
          echo 'case $ARCH in' >> module/customize.sh
          echo '  arm)     ARCH_DIR="arm" ;;' >> module/customize.sh
          echo '  arm64)   ARCH_DIR="arm64" ;;' >> module/customize.sh
          echo '  x86)     ARCH_DIR="x86" ;;' >> module/customize.sh
          echo '  x64)     ARCH_DIR="x86_64" ;;' >> module/customize.sh
          echo '  *)       ARCH_DIR="arm64" ;;' >> module/customize.sh
          echo 'esac' >> module/customize.sh
          echo '' >> module/customize.sh
          echo 'ui_print "- Architecture detected: $ARCH"' >> module/customize.sh
          echo 'ui_print "- Installing BusyBox for $ARCH_DIR..."' >> module/customize.sh
          echo '' >> module/customize.sh
          echo 'if [ ! -d "$MODPATH/custom/$ARCH_DIR" ]; then' >> module/customize.sh
          echo '    ui_print "! Error: Binary for $ARCH_DIR not found in module"' >> module/customize.sh
          echo '    abort' >> module/customize.sh
          echo 'fi' >> module/customize.sh
          echo '' >> module/customize.sh
          echo '# Move content to system/bin' >> module/customize.sh
          echo 'mkdir -p "$MODPATH/system/bin"' >> module/customize.sh
          echo 'cp -af "$MODPATH/custom/$ARCH_DIR/." "$MODPATH/system/bin/"' >> module/customize.sh
          echo 'rm -rf "$MODPATH/custom"' >> module/customize.sh
          echo '' >> module/customize.sh
          echo '# Set permissions' >> module/customize.sh
          echo 'set_perm 0 0 0755 "$MODPATH/system/bin/busybox"' >> module/customize.sh
          echo '' >> module/customize.sh
          echo '# Create symlinks' >> module/customize.sh
          echo 'ui_print "- Creating applet symlinks..."' >> module/customize.sh
          echo 'applist=$("$MODPATH/system/bin/busybox" --list)' >> module/customize.sh
          echo 'for a in $applist; do' >> module/customize.sh
          echo '    if [ "$a" != "busybox" ]; then' >> module/customize.sh
          echo '        ln -sf busybox "$MODPATH/system/bin/$a"' >> module/customize.sh
          echo '    fi' >> module/customize.sh
          echo 'done' >> module/customize.sh
          chmod 755 module/customize.sh

      - name: Package module
        run: |
          cd module
          zip -r ../android-busybox-ndk-v${{ env.BUSYBOX_VERSION }}.zip .
          cd ..

      - name: Upload release asset
        uses: actions/upload-artifact@v4
        with:
          name: magisk-module
          path: android-busybox-ndk-v*.zip

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || format('v{0}', env.BUSYBOX_VERSION) }}
          files: android-busybox-ndk-v*.zip
          body: |
            ## Android BusyBox NDK Magisk Module v${{ env.BUSYBOX_VERSION }}

            **Install via Magisk:**
            1. Download the ZIP below
            2. Open Magisk -> Modules -> Install from storage
            3. Reboot

            **Features:**
            - Static BusyBox binary for maximum compatibility
            - All standard BusyBox applets
            - Symlinks created in /system/xbin
            - Multi-architecture support
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo ""
          echo "========================================"
          echo "  Build Complete!"
          echo "========================================"
          ls -lh android-busybox-ndk-v*.zip
          echo ""
          echo "To trigger a release, push a tag: v1.36.1"
