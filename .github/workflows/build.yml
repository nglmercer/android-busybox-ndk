name: Build and Release Magisk Module

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.36.1)'
        required: true
        default: '1.36.1'

env:
  NDK_VERSION: r25c
  BUSYBOX_VERSION: ${{ github.event.inputs.version || '1.36.1' }}

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      packages: read

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm
            triple: armv7a-linux-androideabi21-
            artifact: busybox-arm
          - arch: arm64
            triple: aarch64-linux-android21-
            artifact: busybox-arm64
          - arch: x86
            triple: i686-linux-android21-
            artifact: busybox-x86
          - arch: x86_64
            triple: x86_64-linux-android21-
            artifact: busybox-x86_64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git wget zip

      - name: Cache Android NDK
        id: cache-ndk
        uses: actions/cache@v4
        with:
          path: android-ndk-${{ env.NDK_VERSION }}-linux.zip
          key: ndk-${{ env.NDK_VERSION }}-${{ runner.os }}

      - name: Download Android NDK
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-${{ env.NDK_VERSION }}-linux.zip

      - name: Extract Android NDK
        run: |
          unzip -q android-ndk-${{ env.NDK_VERSION }}-linux.zip
          echo "NDK_ROOT=${{ github.workspace }}/android-ndk-${{ env.NDK_VERSION }}" >> $GITHUB_ENV

      - name: Build BusyBox for ${{ matrix.arch }}
        run: |
          export NDK_ROOT=${{ env.NDK_ROOT }}
          export PATH=$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
          export ARCH=${{ matrix.arch }}
          export SYSROOT=$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/sysroot
          export CROSS_COMPILE=${{ matrix.triple }}

          cd ${{ github.workspace }}
          wget -q https://busybox.net/downloads/busybox-${{ env.BUSYBOX_VERSION }}.tar.bz2
          tar -xjf busybox-${{ env.BUSYBOX_VERSION }}.tar.bz2
          mv busybox-${{ env.BUSYBOX_VERSION }} busybox-build
          cd busybox-build

          # Create symlinks for gcc names pointing to clang (NDK r25c uses clang only)
          cd $NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin
          for target in aarch64-linux-android21 armv7a-linux-androideabi21 i686-linux-android21 x86_64-linux-android21; do
            for tool in gcc g++ ar as nm objcopy objdump ranlib strip; do
              if [ ! -f "${target}-${tool}" ] && [ -f "${target}-clang" ]; then
                ln -sf ${target}-clang ${target}-${tool}
              fi
            done
          done

          cd ${{ github.workspace }}/busybox-build

          cp ${{ github.workspace }}/osm0sis-basic-unified.config .config
          sed -i "s|CONFIG_CROSS_COMPILER_PREFIX=\"\"|CONFIG_CROSS_COMPILER_PREFIX=\"${NDK_ROOT}/toolchains/llvm/prebuilt/linux-x86_64/bin/${CROSS_COMPILE}\"|g" .config
          sed -i "s|CONFIG_SYSROOT=\"\"|CONFIG_SYSROOT=\"${SYSROOT}\"|g" .config

          # Use clang directly for host tools
          export HOSTCC=gcc
          make -j$(nproc)
          make install

          mkdir -p ${{ github.workspace }}/${{ matrix.artifact }}
          cp -r _install/* ${{ github.workspace }}/${{ matrix.artifact }}/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ github.workspace }}/${{ matrix.artifact }}

  package:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Set up module structure
        run: |
          mkdir -p module/system/bin
          mkdir -p module/META-INF/com/google/android
          mkdir -p module/system
          for dir in artifacts/*; do
            if [ -d "$dir" ]; then
              cp -r "$dir"/* module/system/bin/ 2>/dev/null || true
            fi
          done

      - name: Create module.prop
        run: |
          echo "id=android-busybox-ndk" > module/module.prop
          echo "name=Android BusyBox NDK" >> module/module.prop
          echo "version=${{ env.BUSYBOX_VERSION }}" >> module/module.prop
          echo "versionCode=1" >> module/module.prop
          echo "author=GitHub Actions" >> module/module.prop
          echo "description=BusyBox ${{ env.BUSYBOX_VERSION }} compiled with Android NDK for Magisk" >> module/module.prop

      - name: Create update-binary
        run: |
          echo '#!/bin/sh' > module/META-INF/com/google/android/update-binary
          echo 'umask 022' >> module/META-INF/com/google/android/update-binary
          echo '' >> module/META-INF/com/google/android/update-binary
          echo 'ui_print() { echo "$1"; }' >> module/META-INF/com/google/android/update-binary
          echo '' >> module/META-INF/com/google/android/update-binary
          echo 'ui_print "- Installing BusyBox NDK..."' >> module/META-INF/com/google/android/update-binary
          echo '' >> module/META-INF/com/google/android/update-binary
          echo 'ARCH=$(getprop ro.product.cpu.abi | cut -d"-" -f1)' >> module/META-INF/com/google/android/update-binary
          echo '[ -z "$ARCH" ] && ARCH=$(uname -m)' >> module/META-INF/com/google/android/update-binary
          echo '' >> module/META-INF/com/google/android/update-binary
          echo 'case "$ARCH" in' >> module/META-INF/com/google/android/update-binary
          echo '    arm*) BUSYBOX="busybox-arm" ;;' >> module/META-INF/com/google/android/update-binary
          echo '    aarch64*) BUSYBOX="busybox-arm64" ;;' >> module/META-INF/com/google/android/update-binary
          echo '    i?86*) BUSYBOX="busybox-i686" ;;' >> module/META-INF/com/google/android/update-binary
          echo '    x86_64*) BUSYBOX="busybox-x86_64" ;;' >> module/META-INF/com/google/android/update-binary
          echo '    *) ui_print "- Error: Unknown architecture"; exit 1 ;;' >> module/META-INF/com/google/android/update-binary
          echo 'esac' >> module/META-INF/com/google/android/update-binary
          echo '' >> module/META-INF/com/google/android/update-binary
          echo 'if [ -f "system/bin/${BUSYBOX}/busybox" ]; then' >> module/META-INF/com/google/android/update-binary
          echo '    cp "system/bin/${BUSYBOX}/busybox" system/bin/busybox' >> module/META-INF/com/google/android/update-binary
          echo '    chmod 755 system/bin/busybox' >> module/META-INF/com/google/android/update-binary
          echo '    for applet in $(system/bin/busybox --list); do' >> module/META-INF/com/google/android/update-binary
          echo '        [ ! -e "system/xbin/$applet" ] && ln -sf busybox "system/xbin/$applet"' >> module/META-INF/com/google/android/update-binary
          echo '    done' >> module/META-INF/com/google/android/update-binary
          echo '    ui_print "- Done!"' >> module/META-INF/com/google/android/update-binary
          echo 'else' >> module/META-INF/com/google/android/update-binary
          echo '    ui_print "- Error: Binary not found"' >> module/META-INF/com/google/android/update-binary
          echo '    exit 1' >> module/META-INF/com/google/android/update-binary
          echo 'fi' >> module/META-INF/com/google/android/update-binary
          echo 'exit 0' >> module/META-INF/com/google/android/update-binary
          chmod 755 module/META-INF/com/google/android/update-binary

      - name: Create updater-script
        run: |
          echo 'ui_print(" BusyBox NDK Module");' > module/META-INF/com/google/android/updater-script

      - name: Create post-fs-data.sh
        run: |
          echo '#!/system/bin/sh' > module/post-fs-data.sh
          chmod 755 module/post-fs-data.sh

      - name: Create service.sh
        run: |
          echo '#!/system/bin/sh' > module/service.sh
          chmod 755 module/service.sh

      - name: Create customize.sh
        run: |
          echo '#!/system/bin/sh' > module/customize.sh
          echo 'set_perm(0, 0, 0755, "/system/bin/busybox");' >> module/customize.sh
          echo '' >> module/customize.sh
          echo 'if [ -f "/system/bin/busybox" ]; then' >> module/customize.sh
          echo '    for applet in $(/system/bin/busybox --list); do' >> module/customize.sh
          echo '        [ ! -e "/system/xbin/$applet" ] && ln -sf busybox "/system/xbin/$applet"' >> module/customize.sh
          echo '    done' >> module/customize.sh
          echo 'fi' >> module/customize.sh
          chmod 755 module/customize.sh

      - name: Package module
        run: |
          cd module
          zip -r ../android-busybox-ndk-v${{ env.BUSYBOX_VERSION }}.zip .
          mv ../android-busybox-ndk-v${{ env.BUSYBOX_VERSION }}.zip ../
          cd ..

      - name: Upload release asset
        uses: actions/upload-artifact@v4
        with:
          name: magisk-module
          path: android-busybox-ndk-v*.zip

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: android-busybox-ndk-v*.zip
          body: |
            ## Android BusyBox NDK Magisk Module v${{ env.BUSYBOX_VERSION }}

            **Install via Magisk:**
            1. Download the ZIP below
            2. Open Magisk -> Modules -> Install from storage
            3. Reboot

            **Features:**
            - Static BusyBox binary for maximum compatibility
            - All standard BusyBox applets
            - Symlinks created in /system/xbin
            - Multi-architecture support
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo ""
          echo "========================================"
          echo "  Build Complete!"
          echo "========================================"
          ls -lh android-busybox-ndk-v*.zip
          echo ""
          echo "To trigger a release, push a tag: v1.36.1"
