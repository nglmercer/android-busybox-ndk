name: Build Magisk Module

on:
  push:
    tags:
      - "v*"
    branches:
      - main
  workflow_dispatch:
    inputs:
      busybox_version:
        description: "BusyBox version to build"
        required: false
        default: "1.36.1"
      architectures:
        description: "Architectures to build (space-separated)"
        required: false
        default: "arm arm64 x86 x86_64"

env:
  NDK_VERSION: r25c
  BUSYBOX_VERSION: ${{ github.event.inputs.busybox_version || '1.36.1' }}

jobs:
  build:
    runs-on: ubuntu-latest
    container: ubuntu:22.04
    permissions:
      contents: read
      packages: read

    strategy:
      fail-fast: false
      matrix:
        arch: [arm, arm64, x86, x86_64]
        include:
          - arch: arm
            triple: armv7a-linux-androideabi21-
          - arch: arm64
            triple: aarch64-linux-android21-
          - arch: x86
            triple: i686-linux-android21-
          - arch: x86_64
            triple: x86_64-linux-android21-

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
            build-essential \
            git \
            wget \
            libc6-dev \
            libncurses5-dev \
            zlib1g-dev \
            pkg-config \
            autoconf \
            automake \
            libtool \
            gawk \
            bison \
            texinfo \
            zip

      - name: Cache Android NDK
        id: cache-ndk
        uses: actions/cache@v4
        with:
          path: android-ndk-${{ env.NDK_VERSION }}-linux.zip
          key: ndk-${{ env.NDK_VERSION }}-${{ runner.os }}

      - name: Download Android NDK
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-${{ env.NDK_VERSION }}-linux.zip

      - name: Setup Android NDK
        run: |
          unzip -q android-ndk-${{ env.NDK_VERSION }}-linux.zip
          NDK_PATH="${{ github.workspace }}/android-ndk-${{ env.NDK_VERSION }}"
          echo "NDK_PATH=$NDK_PATH" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$NDK_PATH" >> $GITHUB_ENV

      - name: Create NDK gcc symlinks
        run: |
          # NDK r25c uses clang only, create symlinks for gcc names
          NDK_BIN="${{ env.NDK_PATH }}/toolchains/llvm/prebuilt/linux-x86_64/bin"
          cd "$NDK_BIN"# ... (keeping the rest of symlinks setup implicitly by context if not changing) but wait, replace_file_content expects exact chunks.
          # To avoid re-writing the whole symlink block which is fine, I will just target the specific blocks.

# Chunk 1: Setup NDK
      - name: Setup Android NDK
        run: |
          unzip -q android-ndk-${{ env.NDK_VERSION }}-linux.zip
          NDK_PATH="${{ github.workspace }}/android-ndk-${{ env.NDK_VERSION }}"
          echo "NDK_PATH=$NDK_PATH" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$NDK_PATH" >> $GITHUB_ENV

      - name: Create NDK gcc symlinks
        run: |
          # NDK r25c uses clang only, create symlinks for gcc names
          NDK_BIN="${{ env.NDK_PATH }}/toolchains/llvm/prebuilt/linux-x86_64/bin"
          cd "$NDK_BIN"
          for target in aarch64-linux-android21 armv7a-linux-androideabi21 i686-linux-android21 x86_64-linux-android21; do
            # GCC/G++ -> Clang
            ln -sf "${target}-clang" "${target}-gcc"
            ln -sf "${target}-clang++" "${target}-g++"
            # AS -> Clang
            ln -sf "${target}-clang" "${target}-as"
            # Binutils -> LLVM tools
            ln -sf llvm-ar "${target}-ar"
            ln -sf llvm-nm "${target}-nm"
            ln -sf llvm-objcopy "${target}-objcopy"
            ln -sf llvm-objdump "${target}-objdump"
            ln -sf llvm-ranlib "${target}-ranlib"
            ln -sf llvm-strip "${target}-strip"
          done

      - name: Clone BusyBox
        run: |
          cd "${{ runner.workspace }}"
          wget -q https://busybox.net/downloads/busybox-${{ env.BUSYBOX_VERSION }}.tar.bz2
          tar -xjf busybox-${{ env.BUSYBOX_VERSION }}.tar.bz2
          mv busybox-${{ env.BUSYBOX_VERSION }} busybox-${{ matrix.arch }}
          cd busybox-${{ matrix.arch }}
          git init
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add .
          git commit -m "Initial import of BusyBox ${{ env.BUSYBOX_VERSION }}"

      - name: Apply patches
        run: |
          cd "${{ runner.workspace }}/busybox-${{ matrix.arch }}"
          cp "${{ github.workspace }}/osm0sis-basic-unified.config" .config
          for patch in "${{ github.workspace }}"/patches/*.patch; do
            if [ -f "$patch" ]; then
              git am --whitespace=nowarn "$patch" 2>/dev/null || true
            fi
          done

      - name: Configure BusyBox
        run: |
          cd "${{ runner.workspace }}/busybox-${{ matrix.arch }}"
          CROSS_COMPILE="${{ env.NDK_PATH }}/toolchains/llvm/prebuilt/linux-x86_64/bin/${{ matrix.triple }}"
          echo "CROSS_COMPILE=$CROSS_COMPILE" >> $GITHUB_ENV
          sed -i "s|CONFIG_CROSS_COMPILER_PREFIX=\"\"|CONFIG_CROSS_COMPILER_PREFIX=\"${CROSS_COMPILE}\"|g" .config
          sed -i 's|CONFIG_EXTRA_CFLAGS=.*|CONFIG_EXTRA_CFLAGS="-DANDROID -D__ANDROID__ -D__ANDROID_API__=21 -Os"|g' .config
          sed -i 's|CONFIG_EXTRA_LDFLAGS=.*|CONFIG_EXTRA_LDFLAGS=""|g' .config
          sed -i 's|CONFIG_STATIC=y|# CONFIG_STATIC is not set|g' .config
          sed -i 's|CONFIG_STATIC_LIBGCC=y|# CONFIG_STATIC_LIBGCC is not set|g' .config
          SYSROOT="${{ env.NDK_PATH }}/toolchains/llvm/prebuilt/linux-x86_64/sysroot"
          sed -i "s|CONFIG_SYSROOT=\"\"|CONFIG_SYSROOT=\"${SYSROOT}\"|g" .config

      - name: Build BusyBox
        run: |
          cd "${{ runner.workspace }}/busybox-${{ matrix.arch }}"
          export CROSS_COMPILE="${{ env.CROSS_COMPILE }}"
          export ARCH="${{ matrix.arch }}"
          make -j$(nproc)
          make install

      - name: Create directory structure for Magisk module
        run: |
          mkdir -p "${{ runner.workspace }}"/module/${{ matrix.arch }}
          cd "${{ runner.workspace }}/busybox-${{ matrix.arch }}/_install"
          cp -r * "${{ runner.workspace }}/module/${{ matrix.arch }}"/

      - name: Upload artifact for ${{ matrix.arch }}
        uses: actions/upload-artifact@v4
        with:
          name: busybox-${{ matrix.arch }}
          path: "${{ runner.workspace }}/module/${{ matrix.arch }}"

  package:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Magisk module structure
        run: |
          mkdir -p module/system/bin
          mkdir -p module/system/etc
          mkdir -p module/META-INF/com/google/android
          mkdir -p module/custom
          for arch_dir in artifacts/busybox-*; do
            cp -r "$arch_dir"/* module/ 2>/dev/null || true
          done

      - name: Create module.prop
        run: |
          VERSION=$(echo ${{ github.ref_name }} | sed 's/v//')
          echo "id=android-busybox-ndk" > module/module.prop
          echo "name=Android BusyBox NDK" >> module/module.prop
          echo "version=$VERSION" >> module/module.prop
          echo "versionCode=$(git rev-list --count HEAD)" >> module/module.prop
          echo "author=GitHub Actions" >> module/module.prop
          echo "description=BusyBox compiled with Android NDK for Magisk" >> module/module.prop

      - name: Create update-binary
        run: |
          echo '#!/bin/sh' > module/META-INF/com/google/android/update-binary
          echo 'umask 022' >> module/META-INF/com/google/android/update-binary
          echo '' >> module/META-INF/com/google/android/update-binary
          echo 'ui_print() { echo "$1"; }' >> module/META-INF/com/google/android/update-binary
          echo '' >> module/META-INF/com/google/android/update-binary
          echo 'ui_print "- Installing BusyBox module..."' >> module/META-INF/com/google/android/update-binary
          echo '' >> module/META-INF/com/google/android/update-binary
          echo 'ARCH=$(getprop ro.product.cpu.abi | cut -d"-" -f1)' >> module/META-INF/com/google/android/update-binary
          echo 'if [ -z "$ARCH" ]; then' >> module/META-INF/com/google/android/update-binary
          echo '    ARCH=$(uname -m)' >> module/META-INF/com/google/android/update-binary
          echo 'fi' >> module/META-INF/com/google/android/update-binary
          echo '' >> module/META-INF/com/google/android/update-binary
          echo 'case "$ARCH" in' >> module/META-INF/com/google/android/update-binary
          echo '    arm*) BUSYBOX_PATH="system/bin/arm/busybox" ;;' >> module/META-INF/com/google/android/update-binary
          echo '    aarch64*) BUSYBOX_PATH="system/bin/arm64/busybox" ;;' >> module/META-INF/com/google/android/update-binary
          echo '    i?86*) BUSYBOX_PATH="system/bin/x86/busybox" ;;' >> module/META-INF/com/google/android/update-binary
          echo '    x86_64*) BUSYBOX_PATH="system/bin/x86_64/busybox" ;;' >> module/META-INF/com/google/android/update-binary
          echo '    *) ui_print "- Error: Unknown architecture: $ARCH"; exit 1 ;;' >> module/META-INF/com/google/android/update-binary
          echo 'esac' >> module/META-INF/com/google/android/update-binary
          echo '' >> module/META-INF/com/google/android/update-binary
          echo 'if [ -f "$BUSYBOX_PATH" ]; then' >> module/META-INF/com/google/android/update-binary
          echo '    cp "$BUSYBOX_PATH" /system/bin/busybox' >> module/META-INF/com/google/android/update-binary
          echo '    chmod 755 /system/bin/busybox' >> module/META-INF/com/google/android/update-binary
          echo '    for applet in $(/system/bin/busybox --list); do' >> module/META-INF/com/google/android/update-binary
          echo '        if [ ! -e "/system/bin/$applet" ] && [ ! -e "/system/xbin/$applet" ]; then' >> module/META-INF/com/google/android/update-binary
          echo '            ln -sf busybox "/system/xbin/$applet" 2>/dev/null || true' >> module/META-INF/com/google/android/update-binary
          echo '        fi' >> module/META-INF/com/google/android/update-binary
          echo '    done' >> module/META-INF/com/google/android/update-binary
          echo '    ui_print "- Done!"' >> module/META-INF/com/google/android/update-binary
          echo 'else' >> module/META-INF/com/google/android/update-binary
          echo '    ui_print "- Error: BusyBox binary not found at $BUSYBOX_PATH"' >> module/META-INF/com/google/android/update-binary
          echo '    exit 1' >> module/META-INF/com/google/android/update-binary
          echo 'fi' >> module/META-INF/com/google/android/update-binary
          echo '' >> module/META-INF/com/google/android/update-binary
          echo 'exit 0' >> module/META-INF/com/google/android/update-binary
          chmod +x module/META-INF/com/google/android/update-binary

      - name: Create updater-script
        run: |
          echo '# Magisk updater script' > module/META-INF/com/google/android/updater-script
          echo 'ui_print(" BusyBox NDK Module...");' >> module/META-INF/com/google/android/updater-script
          echo 'set_metadata("module.prop", "mode", "0644");' >> module/META-INF/com/google/android/updater-script
          echo 'set_metadata("system/bin/busybox", "mode", "0755");' >> module/META-INF/com/google/android/updater-script

      - name: Create post-fs-data.sh
        run: |
          echo '#!/system/bin/sh' > module/post-fs-data.sh
          echo '# Post-fs-data script for BusyBox' >> module/post-fs-data.sh
          echo '# Configure any runtime settings here' >> module/post-fs-data.sh
          chmod +x module/post-fs-data.sh

      - name: Create service.sh
        run: |
          echo '#!/system/bin/sh' > module/service.sh
          echo '# Service script for BusyBox' >> module/service.sh
          echo '# Start any daemons here if needed' >> module/service.sh
          chmod +x module/service.sh

      - name: Create customize.sh
        run: |
          echo '#!/system/bin/sh' > module/customize.sh
          echo '# Custom installation script' >> module/customize.sh
          echo '' >> module/customize.sh
          echo '# Set permissions' >> module/customize.sh
          echo 'set_perm(0, 0, 0755, "/system/bin/busybox");' >> module/customize.sh
          echo '' >> module/customize.sh
          echo '# Create symlinks for all applets' >> module/customize.sh
          echo 'if [ -f "/system/bin/busybox" ]; then' >> module/customize.sh
          echo '    for applet in $(/system/bin/busybox --list); do' >> module/customize.sh
          echo '        if [ ! -e "/system/bin/$applet" ] && [ ! -e "/system/xbin/$applet" ]; then' >> module/customize.sh
          echo '            ln -sf /system/bin/busybox /system/xbin/$applet 2>/dev/null' >> module/customize.sh
          echo '        fi' >> module/customize.sh
          echo '    done' >> module/customize.sh
          echo 'fi' >> module/customize.sh
          chmod +x module/customize.sh

      - name: Create zip archive
        run: |
          cd module
          VERSION=$(echo ${{ github.ref_name }} | sed 's/v//')
          ARCHIVE_NAME="android-busybox-ndk-v${VERSION}-${GITHUB_SHA:0:7}.zip"
          zip -r "$ARCHIVE_NAME" .
          mv "$ARCHIVE_NAME" "${{ github.workspace }}"
          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> $GITHUB_ENV

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release
          path: ${{ github.workspace }}/${{ env.ARCHIVE_NAME }}

      - name: Create Release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ github.workspace }}/${{ env.ARCHIVE_NAME }}
          body: |
            ## Android BusyBox NDK Magisk Module

            Pre-built Magisk module containing BusyBox compiled with Android NDK.

            ### Features
            - Static binaries for all architectures
            - All standard BusyBox applets
            - Easy Magisk installation

            ### Installation
            1. Download the ZIP file
            2. Install via Magisk -> Modules -> Install from storage
            3. Reboot
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "Build complete!"
          echo "Archive: ${{ env.ARCHIVE_NAME }}"
          ls -lh ${{ github.workspace }}/${{ env.ARCHIVE_NAME }}
